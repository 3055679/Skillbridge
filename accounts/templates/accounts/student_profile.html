{% extends "base.html" %}
{% load static crispy_forms_tags %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <!-- Left Sidebar - Profile Summary -->
        <div class="col-lg-4">
            <div class="card profile-card mb-4">
                <div class="card-body text-center">
                    <div class="profile-picture-container mb-3" data-bs-toggle="tooltip" title="Change your profile here">
                        <img src="{{ student.profile_picture_url }}" 
                             class="rounded-circle profile-picture" width="150" height="150" alt="Profile picture">
                        <div class="upload-overlay" onclick="document.getElementById('id_profile_picture')?.click()">
                            <i class="bi bi-camera-fill"></i>
                        </div>
                    </div>
                    <h3 class="mb-1">{{ student.user.get_full_name }}</h3>
                    <p class="text-muted mb-2">{{ student.user.email }}</p>
                    {% if student.university %}
                    <p class="text-muted mb-2">{{ student.university }}</p>
                    {% endif %}
                    {% if student.country %}
                    <p class="text-muted mb-2">{{ student.country }}</p>
                    {% endif %}
                    
                    <!-- Work Preference Badge -->
                    {% if student.work_preference %}
                    <div class="mb-3">
                        <span class="badge bg-primary position-relative">
                            {{ student.get_work_preference_display }}
                            <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" 
                               title="{% if student.work_preference == 'INT' %}Internship: Long-term work experience{% elif student.work_preference == 'GIG' %}Gigs: Short-term tasks/projects{% else %}Open to both internship and gigs{% endif %}"></i>
                        </span>
                    </div>
                    {% endif %}
                    
                    <!-- Availability Status -->
                    {% if student.availability %}
                    <div class="availability-badge mb-3">
                        <span class="badge bg-secondary">
                            <i class="bi bi-calendar-check me-1"></i>
                            {{ student.get_availability_display }}
                        </span>
                    </div>
                    {% endif %}
                    
                    <!-- Student ID Status -->
                    {% if student.student_id_document %}
                    <div class="mb-3">
                        <span class="badge {% if student.student_id_verified %}bg-success{% else %}bg-warning{% endif %}">
                            <i class="bi {% if student.student_id_verified %}bi-check-circle{% else %}bi-exclamation-triangle{% endif %} me-1"></i>
                            {% if student.student_id_verified %}Student ID Verified{% else %}Student ID Pending{% endif %}
                        </span>
                    </div>
                    {% else %}
                    <div class="mb-3">
                        <span class="badge bg-danger">
                            <i class="bi bi-exclamation-triangle me-1"></i> Student ID Required
                        </span>
                    </div>
                    {% endif %}
                    
                    <!-- Quick Stats -->
                    <div class="d-flex justify-content-center mb-3">
                        {% if student.github_url %}
                        <a href="{{ student.github_url }}" class="btn btn-dark btn-sm mx-1" target="_blank">
                            <i class="bi bi-github"></i>
                        </a>
                        {% endif %}
                        {% if student.personal_website %}
                        <a href="{{ student.personal_website }}" class="btn btn-outline-primary btn-sm mx-1" target="_blank">
                            <i class="bi bi-globe"></i>
                        </a>
                        {% endif %}
                        {% if student.resume %}
                        <a href="{{ student.resume.url }}" class="btn btn-success btn-sm mx-1" target="_blank">
                            <i class="bi bi-file-earmark-pdf"></i> Resume
                        </a>
                        {% endif %}
                    </div>
                    
                    <!-- Skills Display -->
                    <div class="skills-container text-start mb-4">
                        <h5 class="section-title"><i class="bi bi-tools me-2"></i>Skills</h5>
                        <div class="skills-list mb-3">
                            {% for skill in student.skills.all %}
                                <span class="badge bg-primary skill-badge me-1 mb-1">
                                    {{ skill.name }}
                                    <form action="{% url 'accounts:remove_skill' skill.id %}" method="post" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-link text-white p-0 ms-1" 
                                                onclick="return confirm('Remove {{ skill.name }}?')">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </form>
                                </span>
                            {% empty %}
                                <p class="text-muted small">No skills added yet</p>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Quick Links Card -->
                    <div class="card quick-links-card mb-4" data-bs-toggle="tooltip" title="After updating profile, don't press back, click on Dashboard from Quick Links">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-speedometer2 me-2"></i>Quick Links</h5>
                            <ul class="nav flex-column">
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'jobs:student_dashboard' %}">
                                        <i class="bi bi-speedometer2 me-2"></i> Dashboard
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link active" href="{% url 'accounts:student_profile' %}">
                                        <i class="bi bi-person me-2"></i> My Profile
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'jobs:my_applications' %}">
                                        <i class="bi bi-briefcase me-2"></i> My Applications
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'jobs:resume_builder' %}">
                                        <i class="bi bi-file-earmark-text me-2"></i> Resume Builder
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'jobs:saved_jobs' %}">
                                        <i class="bi bi-bookmark me-2"></i> Saved Jobs
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'jobs:interviews' %}">
                                        <i class="bi bi-calendar-check me-2"></i> Interviews
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'jobs:community' %}">
                                        <i class="bi bi-people me-2"></i> Community
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'jobs:settings' %}">
                                        <i class="bi bi-gear me-2"></i> Settings
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="col-lg-8">
            <!-- Profile Edit Section -->
            <div class="card mb-4" id="profile-section">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>Profile Information</h4>
                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#profileCollapse">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>
                <div class="collapse show" id="profileCollapse">
                    <div class="card-body">
                        <form method="POST" enctype="multipart/form-data" id="profile-form">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="profile">
                            
                            <!-- User Fields -->
                            <h5 class="section-title">Personal Information</h5>
                            {{ user_form|crispy }}
                            
                            <!-- Student Profile Fields -->
                            <h5 class="section-title">Student Profile</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ profile_form.university|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ profile_form.country|as_crispy_field }}
                                </div>
                            </div>
                            {{ profile_form.phone_number|as_crispy_field }}
                            {{ profile_form.bio|as_crispy_field }}
                            <div class="row">
                                <div class="col-md-6">
                                    {{ profile_form.location|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ profile_form.profile_picture|as_crispy_field }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ profile_form.github_url|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ profile_form.personal_website|as_crispy_field }}
                                </div>
                            </div>
                            {{ profile_form.resume|as_crispy_field }}
                            
                            <!-- Student ID (Mandatory) -->
                            <div class="mb-3" data-bs-toggle="tooltip" title="Upload a valid student ID, we can reject if it’s not matching with your data">
                                <label class="form-label">Student ID Document* {% if not student.student_id_document %}<span class="text-danger">(Required)</span>{% endif %}</label>
                                {{ profile_form.student_id_document|as_crispy_field }}
                                <small class="text-muted">Upload a clear image or PDF of your student ID</small>
                            </div>
                            
                            <!-- Work Preference (Mandatory) -->
                            <div class="mb-3">
                                <label class="form-label">Work Preference* {% if not student.work_preference %}<span class="text-danger">(Required)</span>{% endif %}</label>
                                <div class="work-preference-options">
                                    {% for value, label in profile_form.work_preference.field.choices %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" 
                                               name="work_preference" id="work_preference_{{ value }}" 
                                               value="{{ value }}" 
                                               {% if profile_form.work_preference.value == value %}checked{% endif %}
                                               required>
                                        <label class="form-check-label" for="work_preference_{{ value }}">
                                            {{ label|safe }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Availability (Mandatory) -->
                            <div class="mb-3">
                                <label class="form-label">Availability* {% if not student.availability %}<span class="text-danger">(Required)</span>{% endif %}</label>
                                <div class="availability-options">
                                    {% for choice in profile_form.availability.field.choices %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" 
                                               name="availability" id="availability_{{ choice.0 }}" 
                                               value="{{ choice.0 }}" 
                                               {% if profile_form.availability.value == choice.0 %}checked{% endif %}
                                               required>
                                        <label class="form-check-label" for="availability_{{ choice.0 }}">
                                            {{ choice.1 }}
                                        </label>
                                        <small class="text-muted availability-help" 
                                               data-help="{{ choice.1 }}">
                                            <i class="bi bi-info-circle"></i>
                                        </small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2" data-bs-toggle="tooltip" title="After adding all the required fields, save profile">
                                <button type="submit" name="profile_submit" class="btn btn-primary">
                                    <i class="bi bi-save me-1"></i> Save Profile
                                </button>
                            </div>
                        </form>
                        
                        <!-- Separate Skill Addition Form -->
                        <form method="POST" action="{% url 'accounts:add_skill' %}" id="add-skill-form" class="mt-3">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label">Add New Skill</label>
                                {{ profile_form.new_skill|as_crispy_field }}
                                <small class="text-muted">Type a skill and press Enter to add</small>
                            </div>
                            <button type="submit" class="btn btn-outline-primary btn-sm">Add Skill</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Education Section (Mandatory) -->
            <!-- Education Section (Mandatory) -->
            <div class="card mb-4" id="education-section">
                <div class="card-header">
                    <h4 class="mb-0"><i class="bi bi-mortarboard me-2"></i>Education {% if not educations %}<span class="text-danger">(Required)</span>{% endif %}</h4>
                </div>
                <div class="card-body">
                    {% if educations %}
                        <div class="education-list">
                            {% for edu in educations %}
                            <div class="education-item mb-3">
                                <div class="d-flex justify-content-between">
                                    <h5>{{ edu.get_degree_display }} in {{ edu.field_of_study }}</h5>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                type="button" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="{% url 'accounts:edit_education' edu.id %}">Edit</a></li>
                                            <li>
                                                <form method="post" action="{% url 'accounts:delete_education' edu.id %}" style="margin: 0;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="dropdown-item">Delete</button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <p class="text-muted mb-1">{{ edu.institution }}</p>
                                <p class="small text-muted">
                                    {{ edu.start_year }} - 
                                    {% if edu.currently_studying %}Present{% else %}{{ edu.end_year }}{% endif %}
                                </p>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">Please add at least one education entry to apply for jobs.</p>
                    {% endif %}
                    <button class="btn btn-outline-primary mt-2" data-bs-toggle="modal" data-bs-target="#addEducationModal">
                        <i class="bi bi-plus-circle me-1"></i> Add Education
                    </button>
                </div>
            </div>
            
            <!-- Experience Section (Mandatory) -->
            <!-- Experience Section (Mandatory) -->
            <div class="card mb-4" id="experience-section" data-bs-toggle="tooltip" title="Add even the smallest task you have done">
                <div class="card-header">
                    <h4 class="mb-0"><i class="bi bi-briefcase me-2"></i>Experience {% if not experiences %}<span class="text-danger">(Required)</span>{% endif %}</h4>
                </div>
                <div class="card-body">
                    {% if experiences %}
                        <div class="experience-list">
                            {% for exp in experiences %}
                            <div class="experience-item mb-3">
                                <div class="d-flex justify-content-between">
                                    <h5>{{ exp.title }}</h5>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                type="button" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="{% url 'accounts:edit_experience' exp.id %}">Edit</a></li>
                                            <li>
                                                <form method="post" action="{% url 'accounts:delete_experience' exp.id %}" style="margin: 0;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="dropdown-item">Delete</button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <p class="text-muted mb-1">{{ exp.company }}</p>
                                <p class="small text-muted">
                                    {{ exp.start_date|date:"M Y" }} - 
                                    {% if exp.currently_working %}Present{% else %}{{ exp.end_date|date:"M Y" }}{% endif %}
                                </p>
                                {% if exp.description %}
                                <p class="mb-1">{{ exp.description }}</p>
                                {% endif %}
                                {% if exp.document %}
                                <p class="small"><a href="{{ exp.document.url }}" target="_blank">View Document (Pay Slip/Certificate)</a></p>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">Please add at least one experience entry to apply for jobs.</p>
                    {% endif %}
                    <button class="btn btn-outline-primary mt-2" data-bs-toggle="modal" data-bs-target="#addExperienceModal">
                        <i class="bi bi-plus-circle me-1"></i> Add Experience
                    </button>
                </div>
            </div>
            
            <!-- Portfolio Section (Mandatory) -->
            <!-- Portfolio Section -->
            <div class="card mb-4" id="portfolio-section" data-bs-toggle="tooltip" title="Showcase your projects or work samples">
                <div class="card-header">
                    <h4 class="mb-0"><i class="bi bi-folder me-2"></i>Portfolio</h4>
                </div>
                <div class="card-body">
                    {% if portfolios %}
                        <div class="portfolio-list">
                            {% for portfolio in portfolios %}
                            <div class="portfolio-item mb-3">
                                <div class="d-flex justify-content-between">
                                    <h5>{{ portfolio.title }}</h5>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                type="button" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="{% url 'accounts:edit_portfolio' portfolio.id %}">Edit</a></li>
                                            <li><a class="dropdown-item" href="{% url 'accounts:view_portfolio' portfolio.id %}">View</a></li>
                                            <li>
                                                <form method="post" action="{% url 'accounts:delete_portfolio' portfolio.id %}" style="margin: 0;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="dropdown-item">Delete</button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <p class="text-muted mb-1">{{ portfolio.description|truncatewords:20 }}</p>
                                {% if portfolio.url %}
                                <p class="small"><a href="{{ portfolio.url }}" target="_blank">View Project</a></p>
                                {% endif %}
                                {% if portfolio.media %}
                                <p class="small"><a href="{{ portfolio.media.url }}" target="_blank">View Media</a></p>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No portfolio entries added. Add projects to showcase your work.</p>
                    {% endif %}
                    <button class="btn btn-outline-primary mt-2" data-bs-toggle="modal" data-bs-target="#addPortfolioModal">
                        <i class="bi bi-plus-circle me-1"></i> Add Portfolio
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Education Modal -->
<div class="modal fade" id="addEducationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Education</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="education">
                    {{ education_formset|crispy }}
                    {{ education_formset.management_form }}
                    <div class="d-grid gap-2">
                        <button type="submit" name="education_submit" class="btn btn-primary">Save Education</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Experience Modal -->
<div class="modal fade" id="addExperienceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Work Experience</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="experience">
                    {{ experience_formset|crispy }}
                    {{ experience_formset.management_form }}
                    <div class="d-grid gap-2">
                        <button type="submit" name="experience_submit" class="btn btn-primary">Save Experience</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Portfolio Modal -->
<div class="modal fade" id="addPortfolioModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Portfolio Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="portfolio">
                    {{ portfolio_formset|crispy }}
                    {{ portfolio_formset.management_form }}
                    <div class="d-grid gap-2">
                        <button type="submit" name="portfolio_submit" class="btn btn-primary">Save Portfolio Item</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Profile Picture Upload Styling */
.profile-picture-container {
    position: relative;
    display: inline-block;
    cursor: pointer;
}
.upload-overlay {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: rgba(0,0,0,0.5);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.3s;
}
.profile-picture-container:hover .upload-overlay {
    opacity: 1;
}

/* Work Preference Styling */
.work-preference-options .form-check {
    padding-left: 0;
    margin-bottom: 10px;
}
.work-preference-options .form-check-input {
    margin-left: 0;
    margin-right: 10px;
    margin-top: 0.3em;
}

/* Availability Styling */
.availability-options .form-check {
    margin-bottom: 8px;
}
.availability-help {
    margin-left: 10px;
    cursor: help;
    opacity: 0.5;
    transition: opacity 0.3s;
}
.availability-options .form-check:hover .availability-help {
    opacity: 1;
}

/* Skills Styling */
.skills-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.skill-badge {
    background-color: #007bff;
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    transition: background-color 0.3s;
}
.skill-badge:hover {
    background-color: #0056b3;
}
.select2-container--default .select2-selection--multiple {
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    min-height: 38px;
}
.select2-container--default .select2-selection--multiple .select2-selection__choice {
    background-color: #007bff;
    color: white;
    border-radius: 15px;
    padding: 2px 8px;
    margin: 4px;
}
.select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
    color: white;
    margin-right: 5px;
}

/* Section Styling */
.section-title {
    font-size: 1.1rem;
    color: #495057;
    border-bottom: 1px solid #eee;
    padding-bottom: 8px;
    margin-bottom: 15px;
}

/* Portfolio Gallery */
.portfolio-gallery .portfolio-item {
    transition: transform 0.3s, box-shadow 0.3s;
}
.portfolio-gallery .portfolio-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.portfolio-gallery .card-img-top {
    object-fit: cover;
    height: 150px;
}
.portfolio-gallery video {
    width: 100%;
    height: 150px;
}

/* Required Field Indicator */
.text-danger {
    font-size: 0.85rem;
    font-weight: 500;
}
.asteriskField { color:#dc3545; }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Initialize Bootstrap tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipTriggerList.forEach(tooltipTriggerEl => {
            try {
                new bootstrap.Tooltip(tooltipTriggerEl);
            } catch (e) {
                console.error('Tooltip initialization failed:', e);
            }
        });
        
        // Initialize Select2 for skills
        if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
            const select2Element = document.querySelector('.select2-skills');
            if (select2Element) {
                const removeSkillUrlTemplate = '{% url "accounts:remove_skill" 0 %}'.replace('0', '{skill_id}');
                
                $(select2Element).select2({
                    placeholder: "Select or type skills",
                    allowClear: true,
                    tags: true,
                    tokenSeparators: [',', ' '],
                    width: '100%',
                    createTag: function(params) {
                        return {
                            id: params.term,
                            text: params.term,
                            newOption: true
                        };
                    }
                }).on('select2:select', function(e) {
                    if (e.params.data.newOption) {
                        // Submit new skill via AJAX
                        $.ajax({
                            url: '{% url "accounts:add_skill" %}',
                            method: 'POST',
                            data: {
                                new_skill: e.params.data.text,
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            },
                            success: function(response) {
                                // Refresh page to show updated skills
                                window.location.reload();
                            },
                            error: function(xhr) {
                                alert('Error adding skill: ' + (xhr.responseJSON?.error || 'Unknown error'));
                            }
                        });
                    }
                }).on('select2:unselect', function(e) {
                    // Remove skill via AJAX
                    if (!e.params.data.newOption) { // Only remove existing skills
                        const skillId = e.params.data.id;
                        const removeUrl = removeSkillUrlTemplate.replace('{skill_id}', skillId);
                        $.ajax({
                            url: removeUrl,
                            method: 'POST',
                            data: {
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            },
                            success: function(response) {
                                // Refresh page to show updated skills
                                window.location.reload();
                            },
                            error: function(xhr) {
                                alert('Error removing skill: ' + (xhr.responseJSON?.error || 'Unknown error'));
                            }
                        });
                    }
                });
            } else {
                console.warn('Select2 element (.select2-skills) not found');
            }
        } else {
            console.error('jQuery or Select2 not loaded');
        }
        
        // Profile picture upload preview
        const profilePictureInput = document.getElementById('id_profile_picture');
        if (profilePictureInput) {
            profilePictureInput.addEventListener('change', function() {
                try {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const profilePicture = document.querySelector('.profile-picture');
                            if (profilePicture) {
                                profilePicture.src = e.target.result;
                            } else {
                                console.warn('Profile picture element not found');
                            }
                        };
                        reader.readAsDataURL(this.files[0]);
                    }
                } catch (e) {
                    console.error('Profile picture preview failed:', e);
                }
            });
        } else {
            console.warn('Profile picture input (#id_profile_picture) not found');
        }
        
        // Availability help text on hover
        document.querySelectorAll('.availability-options .form-check').forEach(item => {
            item.addEventListener('mouseenter', function() {
                try {
                    const helpText = this.querySelector('.availability-help');
                    if (helpText) helpText.style.opacity = '1';
                } catch (e) {
                    console.error('Availability hover failed:', e);
                }
            });
            item.addEventListener('mouseleave', function() {
                try {
                    const helpText = this.querySelector('.availability-help');
                    if (helpText) helpText.style.opacity = '0.5';
                } catch (e) {
                    console.error('Availability hover failed:', e);
                }
            });
        });

        // Prevent Enter key from submitting profile form in new_skill input
        const newSkillInput = document.getElementById('id_new_skill');
        if (newSkillInput) {
            newSkillInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const addSkillForm = document.getElementById('add-skill-form');
                    if (addSkillForm) {
                        addSkillForm.submit();
                    } else {
                        console.warn('Add skill form (#add-skill-form) not found');
                    }
                }
            });
        } else {
            console.warn('New skill input (#id_new_skill) not found');
        }

        // Add confirmation for skill removal in sidebar
        document.querySelectorAll('.skills-list form').forEach(form => {
            form.addEventListener('submit', function(e) {
                try {
                    if (!confirm('Are you sure you want to remove this skill?')) {
                        e.preventDefault();
                    }
                } catch (e) {
                    console.error('Skill removal confirmation failed:', e);
                }
            });
        });
    } catch (e) {
        console.error('Script initialization failed:', e);
    }
});

//profile picture
function getCookie(name){
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}
const csrftoken = getCookie('csrftoken');

document.addEventListener('DOMContentLoaded', function() {
  const profilePictureInput = document.getElementById('id_profile_picture');
  const imgEl = document.querySelector('.profile-picture');

  if (profilePictureInput) {
    profilePictureInput.addEventListener('change', function () {
      if (!this.files || !this.files[0]) return;

      // instant preview
      const reader = new FileReader();
      reader.onload = e => { if (imgEl) imgEl.src = e.target.result; };
      reader.readAsDataURL(this.files[0]);

      // upload immediately so it persists even if the big form fails
      const fd = new FormData();
      fd.append('profile_picture', this.files[0]);

      fetch("{% url 'accounts:upload_profile_picture' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: fd,
        credentials: 'same-origin'
      })
      .then(r => r.json())
      .then(data => {
        if (!data.ok) {
          alert(data.error || 'Upload failed');
        } else {
          // replace src with the real saved URL to bust cache
          imgEl.src = data.url + '?v=' + Date.now();
        }
      })
      .catch(() => alert('Upload failed'));
    });
  }
});
</script>
{% endblock %}