{% extends "base.html" %}
{% load static %}
{% block messages %}{% endblock %}  {# suppress global alerts for this page #}

{% block title %}Take Assessment | SkillBridge{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #4361ee;
        --secondary-color: #3f37c9;
        --accent-color: #4895ef;
        --light-bg: #f8f9fa;
        --dark-bg: #212529;
    }

    main {
        padding-top: 1.5rem;
        background-color: var(--light-bg);
        min-height: 100vh;
    }

    .section-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
        transition: all 0.3s ease;
    }

    .section-card:hover {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
    }

    .section-card .card-header {
        background: linear-gradient(135deg, #4361ee, #3a0ca3);
        color: white;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 12px 12px 0 0 !important;
        padding: 1.25rem 1.5rem;
    }

    .question-card, .task-card {
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        background: white;
    }

    .question-card label, .task-card label {
        display: block;
        margin-bottom: 0.5rem;
    }

    .question-card textarea, .task-card input, .task-card textarea {
        width: 100%;
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 0.5rem;
        font-size: 1rem;
    }

    .messages {
        list-style: none;
        padding: 0;
    }

    .messages li {
        padding: 0.75rem;
        margin-bottom: 1rem;
        border-radius: 8px;
    }

    .messages li.success {
        background-color: #d4edda;
        color: #155724;
    }

    .messages li.error, .messages li.warning {
        background-color: #f8d7da;
        color: #721c24;
    }

    .btn-primary, .btn-outline-primary {
        transition: all 0.3s ease;
    }

    .btn-primary:hover, .btn-outline-primary:hover {
        transform: translateY(-2px);
    }

    #timer {
        font-size: 1.2rem;
        font-weight: bold;
        color: #212529;
    }

    #timer.warning {
        color: #dc3545;
    }

    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    @media (max-width: 768px) {
        main {
            padding-top: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <main class="col-12 px-md-4">
            <div class="section-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="mb-0"><i class="bi bi-clipboard-check me-2"></i> Assessment</h2>
                    <div id="timer">Time Remaining: <span id="time-left">30:00</span></div>
                </div>
                <div class="card-body">
                    <p><strong>Time limit:</strong> 30 minutes</p>

                    {% if messages %}
                    <ul class="messages">
                        {% for message in messages %}
                        <li class="{{ message.tags }}">{{ message }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}

                    {% if assessment.questions or assessment.tasks %}
                    <!-- Save Answers Form -->
                    <form id="save-answers-form" method="POST" action="{% url 'assessments:assessment_take' assessment.token %}">
                        {% csrf_token %}
                        {% if assessment.questions %}
                        <h3>Questions</h3>
                        {% for q in assessment.questions %}
                        <div class="question-card">
                            <p><strong>Q{{ forloop.counter }} (ID: {{ q.id }})</strong> {{ q.text }}</p>
                            {% if q.qtype == "mcq" %}
                            {% for c in q.choices %}
                            <label>
                                <input type="radio" name="q_{{ q.id }}" value="{{ c.key }}"
                                    {% for response in responses %}{% if response.ref_type == 'q' and response.ref_id == q.id and response.answer == c.key %}checked{% endif %}{% endfor %}>
                                {{ c.key }}) {{ c.text }}
                            </label>
                            {% endfor %}
                            {% elif q.qtype == "short" %}
                            <textarea name="q_{{ q.id }}" rows="4" placeholder="Enter your answer">
{% for response in responses %}{% if response.ref_type == 'q' and response.ref_id == q.id %}{{ response.answer }}{% endif %}{% endfor %}</textarea>
                            {% elif q.qtype == "code" %}
                            <textarea name="q_{{ q.id }}" rows="10" placeholder="{{ q.starter|default:'Enter your code here' }}">
{% for response in responses %}{% if response.ref_type == 'q' and response.ref_id == q.id %}{{ response.answer }}{% endif %}{% endfor %}</textarea>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% endif %}

                        {% if assessment.tasks %}
                        <h3>Tasks</h3>
                        {% for t in assessment.tasks %}
                        <div class="task-card">
                            <p><strong>{{ t.title }} (ID: {{ t.id }})</strong></p>
                            <p>{{ t.instructions }}</p>
                            <input type="text" name="t_{{ t.id }}" placeholder="Paste link to your artifact (Drive/GitHub/Figma/etc.)"
                                value="{% for response in responses %}{% if response.ref_type == 't' and response.ref_id == t.id %}{{ response.answer }}{% endif %}{% endfor %}">
                        </div>
                        {% endfor %}
                        {% endif %}

                        <button type="submit" class="btn btn-outline-primary mb-3">Save Answers</button>
                    </form>

                    <!-- Submit Assessment Form -->
                    <form id="submit-assessment-form" method="POST" action="{% url 'assessments:assessment_submit' assessment.token %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary" id="submit-button" disabled>Submit Assessment</button>
                    </form>
                    {% else %}
                    <p class="text-muted">No questions or tasks available for this assessment.</p>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Timer logic
    const duration = 30 * 60 * 1000; // 30 minutes in milliseconds
    const timerDisplay = document.getElementById('time-left');
    const submitButton = document.getElementById('submit-button');
    const saveForm = document.getElementById('save-answers-form');
    const submitForm = document.getElementById('submit-assessment-form');

    // Check if responses exist to enable submit button
    fetch('{% url "assessments:assessment_take" assessment.token %}?check_responses=true')
        .then(response => response.json())
        .then(data => {
            if (data.response_count > 0) {
                submitButton.disabled = false;
            }
        });

    // Enable submit button after successful save
    saveForm.addEventListener('submit', function(event) {
        setTimeout(() => {
            submitButton.disabled = false;
        }, 1000); // Delay to ensure responses are saved
    });

    // Start timer
    let startTime = new Date('{{ assessment.started_at|date:"c" }}').getTime() || Date.now();
    let endTime = startTime + duration;

    function updateTimer() {
        let now = Date.now();
        let timeLeft = endTime - now;

        if (timeLeft <= 0) {
            timerDisplay.textContent = '00:00';
            timerDisplay.classList.add('warning');
            submitForm.submit(); // Auto-submit when time expires
            return;
        }

        let minutes = Math.floor(timeLeft / 1000 / 60);
        let seconds = Math.floor((timeLeft / 1000) % 60);
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        if (timeLeft < 5 * 60 * 1000) { // Warn at 5 minutes remaining
            timerDisplay.classList.add('warning');
        }
        setTimeout(updateTimer, 1000);
    }

    updateTimer();
});
</script>
{% endblock %}